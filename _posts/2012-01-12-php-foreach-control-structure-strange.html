---
title: "php foreach control structure strange behavior"
layout: "post"
permalink: "/2012/01/php-foreach-control-structure-strange.html"
---

<div class="css-full-post-content js-full-post-content">
It was one year ago, when I start to program intensively in PHP, I encounter a strange behavior when using php control structure foreach.<br /><br />the simple code snippet is as follows :<br /><br /><!--?php<br-->&nbsp; $a = array('a', 'b', 'c', 'd','e','f','g');<br /><br />&nbsp; foreach ($a as &amp;$v) { }<br />&nbsp; foreach ($a as $v) { }<br /><br />&nbsp; print_r($a);<br />?&gt;<br /><br />the output of this program is:<br />Array<br />(<br />&nbsp;&nbsp;&nbsp; [0] =&gt; a<br />&nbsp;&nbsp;&nbsp; [1] =&gt; b<br />&nbsp;&nbsp;&nbsp; [2] =&gt; c<br />&nbsp;&nbsp;&nbsp; [3] =&gt; d<br />&nbsp;&nbsp;&nbsp; [4] =&gt; e<br />&nbsp;&nbsp;&nbsp; [5] =&gt; f<br />&nbsp;&nbsp;&nbsp; <span style="color: red;">[6] =&gt; f</span><br />)<br /><br />you can see that the last array element $a[6]: instead of expected result 'g', it is 'f'.<br /><br /><span style="font-size: small;"><b>Why this happens?</b></span><br /><br /> I found the reason behind on php.net <a href="http://uk.php.net/manual/en/control-structures.foreach.php" target="_blank">foreach page</a><br /><br />it is caused by passing by reference mechanism for foreach structure.<br /><br />let me demonstrate what happens when these foreach statement executes:<br /><br />1) as the in the first foreach statement, array is passed by reference to variable $v, when this foreach finish, <b>variable $v still refer to the last element of array $a</b>, as show in Image 1<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-mAQDaNwM2MI/Tw7-p-zy3rI/AAAAAAAAFA0/k52JVdwLCc4/s1600/1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="87" src="http://2.bp.blogspot.com/-mAQDaNwM2MI/Tw7-p-zy3rI/AAAAAAAAFA0/k52JVdwLCc4/s320/1.png" width="320" /></a></div><div style="text-align: center;">Image 1 value after first foreach</div><br />2) in the second foreach statement, variable $v is assigned with value $a[0], $a[1], $a[2], $a[3], $a[4], $a[5], $a[6],&nbsp; as $v has the same memory address with $a[6],&nbsp; before the last assignment $v = $a[6], $a[6] has the same value as $a[5]. so the last assignment will let $a[6] be assigned value 'f', see Image 2<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-CdnjEglNLS8/Tw8CqSIGsYI/AAAAAAAAFA8/2PTxBYDpMDU/s1600/2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="183" src="http://2.bp.blogspot.com/-CdnjEglNLS8/Tw8CqSIGsYI/AAAAAAAAFA8/2PTxBYDpMDU/s320/2.png" width="320" /></a></div><div style="text-align: center;">Image 2 value after second foreach</div><br /><b>Solution</b> :&nbsp; to solve this problem, the key is to break address reference of $a[6] and $v. we can use unset function to unset variable $v<br /><br /><!--?php<br-->&nbsp; $a = array('a', 'b', 'c', 'd','e','f','g');<br /><br />&nbsp; foreach ($a as &amp;$v) { }<br />&nbsp; <span style="color: red;">unset($v)</span><br />&nbsp; foreach ($a as $v) { }<br /><br />&nbsp; print_r($a);<br />?&gt;<br /><br /><b>More Question</b>:&nbsp; I am wondering if it is possible to have php to provide native support to unset variable reference automatically after foreach statement.&nbsp; I am studying php engine implementation, maybe I can find answer when I understand how php implement array data structure.<br /><br />if you know the answer, please let me know
</div>