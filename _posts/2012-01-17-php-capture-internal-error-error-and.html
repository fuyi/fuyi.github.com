---
title: "php capture internal error E_RROR and return HTTP 500 status code  to Apache"
layout: "post"
permalink: "/2012/01/php-capture-internal-error-error-and.html"
---

<div class="css-full-post-content js-full-post-content">
In LAMP stack development, apache acts as a proxy between client (usually web browser) and php module for dynamic content rendering. the request flow is:<br />1) client send&nbsp; URL request to apache for demaned resource<br />2) apache receive the request, pass all parameters to PHP module<br />3) PHP interpreter execute script and return header as well as generated html content to apache<br />4) apache again, as a proxy, send back what it received from php execution to client<br /><br />During this request flow, apache won't change any http response header information unless php tell it to change. this raise a problem to handle php internal error type E_ERROR correctly. because even E_ERROR occurs during php execution, php script exit exceptionally, apache can not be notified with this type of error and return http status code 500; instead, the default http status code 200 is returned to client with empty output.<br /><br />This is obviously not a pleasant experience for the client. we want to return 500 Internal Error http status code with a well designed 500 error page. So how could we do it?<br /><br />Yes, we can tell apache when internal error occurs while php execution, by the statement : header("HTTP/1.1 500 Internal Error") . sounds easy. isn't it?<br /><br />Here comes the tricky part, How can we capture E_ERROR in php?<br /><br />trigger_error() and set_error_handler() doesn't work in this scenario as set_error_handler() is only invoked when user defined error occurs: see php.net for&nbsp; <a href="http://se.php.net/manual/en/function.set-error-handler.php" target="_blank">set_error_handler()</a><br /><br />"The following error types cannot be handled with a user defined    function: <b><tt>E_ERROR</tt></b>, <b><tt>E_PARSE</tt></b>,    <b><tt>E_CORE_ERROR</tt></b>, <b><tt>E_CORE_WARNING</tt></b>,    <b><tt>E_COMPILE_ERROR</tt></b>,    <b><tt>E_COMPILE_WARNING</tt></b>, and    most of <b><tt>E_STRICT</tt></b> raised in the file where    <span class="function"><b>set_error_handler()</b></span> is called." <br /><br /><b>Solution</b>:<br /><br />In order to solve this problem,&nbsp; we need to take 2 steps,<br /><br />1) first of all, we need to catch PHP fatal errors, which is error  type E_ERROR. when this error occurs, script will be stored the error  and terminate execution. we can get the stored error by calling  function error_get_last().<br />2) before script terminated, a callback function  register_shutdown_function() will always be called. so we need to  register a error handler by this function to do whatever we want, in this  case, return header 500 and a customized internal error page (optional).<br /><code><br /></code><br /><pre class="lang-php prettyprint"><code><code><span class="kwd">function</span><span class="pln"> my_error_handler</span><span class="pun">()</span><span class="pln"><br /></span><span class="pun">{</span><span class="pln"><br />&nbsp; $last_error </span><span class="pun">=</span><span class="pln"> error_get_last</span><span class="pun">();</span><span class="pln"><br />&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$last_error </span><span class="pun">&amp;&amp;</span><span class="pln"> $last_error</span><span class="pun">[</span><span class="str">'type'</span><span class="pun">]==</span><span class="pln">E_ERROR</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; header</span><span class="pun">(</span><span class="str">'HTTP/1.1 500'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'internal error'</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="str">'...'</span><span class="pun">;</span><span class="com">//html for 500 page</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></code></pre><pre class="lang-php prettyprint"><code><code><span class="pun">&nbsp;</span><span class="pln"><br />register_shutdown_function</span><span class="pun">(</span><span class="str">'my_error_handler'</span><span class="pun">);</span><span class="pln"><br /></span></code></code></pre><br /><br />
</div>